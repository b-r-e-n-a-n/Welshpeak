<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Welshpeak</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 32px; }
      textarea { width: 100%; max-width: 720px; font-size: 18px; padding: 8px; }
      button { font-size: 16px; padding: 6px 12px; margin-top: 8px; margin-right: 8px; }
      .muted { color:#666; max-width: 720px; }
      #status { margin-top: 8px; }
    </style>
  </head>
  <body>
    <h1>Welshpeak</h1>
    <p class="muted">For this test, type normal Welsh text (e.g., <i>Cymru am byth</i>). We’ll switch to IPA after the engine API is confirmed.</p>

    <textarea id="ipaInput" rows="3" placeholder="Cymru am byth"></textarea><br/>
    <button id="playBtn">Play</button>
    <button id="stopBtn">Stop</button>
    <div id="status" class="muted"></div>

    <script type="module">
      import initEspeak from "./vendor/espeakng/espeak-ng.js";

      const statusEl = document.getElementById("status");
      const setStatus = (msg) => statusEl.textContent = msg;

      let Module = null;

      try {
        Module = await initEspeak({
          locateFile: (p) => `./vendor/espeakng/${p}`
        });
        console.log("eSpeak-NG initialized?", !!Module);

        // Show keys so we can see what's exposed
        const keys = Object.keys(Module).sort();
        console.log("Module keys:", keys);

        // Try to detect a high-level API
        const setVoice = Module.setVoice || Module.setVoiceName || Module.loadVoice || Module.setvoice || null;
        const speak = Module.speak || Module.synthesize || Module.say || null;

        console.log("Has setVoice-like:", !!setVoice);
        console.log("Has speak-like:", !!speak);

        // Wire Play using whatever is available
        document.getElementById("playBtn").onclick = async () => {
          const text = (document.getElementById("ipaInput").value || "Cymru am byth").trim();

          if (setVoice && speak) {
            try {
              // try setting Welsh (cy); some builds accept 'cy' or 'welsh'
              const voiceCode = "cy";
              const vr = await Promise.resolve(setVoice.call(Module, voiceCode));
              console.log("setVoice result:", vr);
            } catch (e) {
              console.warn("setVoice failed (continuing):", e);
            }

            try {
              const r = await Promise.resolve(speak.call(Module, text));
              console.log("speak result:", r);
              setStatus("Played via high-level API.");
            } catch (e) {
              console.error("speak failed:", e);
              setStatus("High-level speak failed. Check console.");
            }
            return;
          }

          setStatus("Engine API not available in this build (no speak()/setVoice()). We’ll switch approach next.");
          console.warn("No high-level API found; keys:", keys);
        };

        document.getElementById("stopBtn").onclick = () => {
          // Some builds expose stop()/cancel(); attempt if present
          const stop = Module.stop || Module.cancel || null;
          if (stop) {
            try { stop.call(Module); setStatus("Stopped."); } catch(e) { console.warn("stop failed:", e); }
          } else {
            setStatus("Stop not supported in this build.");
          }
        };

      } catch (err) {
        console.error("eSpeak-NG init failed:", err);
        setStatus("Engine failed to initialize. See console.");
      }
    </script>
  </body>
</html>
